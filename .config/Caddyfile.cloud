# =============================================================================
# Caddyfile.cloud - GCE 雲端部署 Caddy 配置
# =============================================================================
#
# 功能：
#   - 自動申請和更新 Let's Encrypt SSL 憑證
#   - 反向代理 API 請求到 Flask 後端
#   - 處理 CORS (跨域資源共享) headers
#   - 支援 Cloudflare Proxy 的真實 IP 識別
#
# 環境變數 (設定於 .secret/caddy.env)：
#   - SITE_ADDRESS: API 網域 (例如: api.nojteam.com)
#   - ADMIN_EMAIL: Let's Encrypt 通知信箱
#
# =============================================================================

# -----------------------------------------------------------------------------
# CORS 巨集定義
# -----------------------------------------------------------------------------
# 用於動態設定 Access-Control-Allow-Origin header
# 使用正則表達式匹配允許的來源
# -----------------------------------------------------------------------------
(cors) {
	@origin{args[0]} header_regexp origin Origin {args[0]}
	header @origin{args[0]} Access-Control-Allow-Origin {re.origin.0}
}

# -----------------------------------------------------------------------------
# 主要網站配置
# -----------------------------------------------------------------------------
# {$SITE_ADDRESS} 會被替換為環境變數中的值
# 例如: api.nojteam.com
# -----------------------------------------------------------------------------
{$SITE_ADDRESS} {
	# -------------------------------------------------------------------------
	# Cloudflare Proxy 識別
	# -------------------------------------------------------------------------
	# 當請求經過 Cloudflare Proxy 時，真實客戶端 IP 會在 CF-Connecting-IP header
	# 參考: https://developers.cloudflare.com/fundamentals/reference/http-request-headers/#cf-connecting-ip
	# -------------------------------------------------------------------------
	@fromCloudflare {
		header CF-Connecting-IP *
	}

	# -------------------------------------------------------------------------
	# 日誌記錄
	# -------------------------------------------------------------------------
	log

	# -------------------------------------------------------------------------
	# CORS Headers
	# -------------------------------------------------------------------------
	# Access-Control-Allow-Headers: 允許的請求標頭
	# Access-Control-Allow-Methods: 允許的 HTTP 方法
	# Access-Control-Allow-Credentials: 允許攜帶 cookies
	# -------------------------------------------------------------------------
	header Access-Control-Allow-Headers "Content-Type, Authorization"
	header Access-Control-Allow-Methods "OPTIONS, GET, POST, PUT, DELETE, HEAD, PATCH"
	header Access-Control-Allow-Credentials true

	# -------------------------------------------------------------------------
	# 允許的來源 (CORS Origins)
	# -------------------------------------------------------------------------
	# 以下網域可以跨域存取此 API：
	#
	# 1. nojteam.com - 正式環境前端
	# 2. *.nfe.pages.dev - Cloudflare Pages 預覽部署
	# 3. localhost - 本地開發環境
	# -------------------------------------------------------------------------
	import cors "https://([^.]+\.)?nojteam\.com"
	import cors "https://([^.]+\.)?nfe\.pages\.dev"
	import cors "http://localhost(:\d+)?"

	# -------------------------------------------------------------------------
	# Metrics 端點 (可選)
	# -------------------------------------------------------------------------
	# 提供 Prometheus 格式的監控指標
	# 存取方式: https://api.nojteam.com/metrics
	# -------------------------------------------------------------------------
	metrics /metrics

	# -------------------------------------------------------------------------
	# 反向代理設定
	# -------------------------------------------------------------------------
	# 來自 Cloudflare 的請求：保留原始 IP 鏈
	# 其他請求：直接代理到後端
	# -------------------------------------------------------------------------
	handle @fromCloudflare {
		reverse_proxy web:8080 {
			# 將 Cloudflare 的真實客戶端 IP 加入 X-Forwarded-For 鏈
			header_up X-Forwarded-For "{header.X-Forwarded-For}, {header.CF-Connecting-IP}"
		}
	}

	# 一般請求直接代理
	reverse_proxy web:8080
}

# -----------------------------------------------------------------------------
# HTTP 重導向 (可選)
# -----------------------------------------------------------------------------
# 如果需要處理 HTTP 請求，Caddy 會自動重導向到 HTTPS
# 不需要額外設定，Caddy 預設行為
# -----------------------------------------------------------------------------
