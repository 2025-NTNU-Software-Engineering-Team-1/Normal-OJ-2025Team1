# Trial Submission åŠŸèƒ½å®Œæ•´åº¦æª¢è¦–å ±å‘Š

## ğŸ“Š å®Œæˆåº¦è©•ä¼°

### âœ… å·²å®ŒæˆåŠŸèƒ½

#### å¾Œç«¯ (Back-End)
- [x] Trial Submission è³‡æ–™æ¨¡å‹ (`TrialSubmission`)
- [x] å»ºç«‹ Trial Submission API (`/problem/<id>/trial/request`)
- [x] ä¸Šå‚³ç¨‹å¼ç¢¼èˆ‡è‡ªè¨‚æ¸¬è³‡ API (`/trial-submission/<id>/files`)
- [x] å–å¾— Trial Submission è¨˜éŒ„ API (`/trial-submission/<id>`)
- [x] ä¸‹è¼‰å–®ä¸€æ¡ˆä¾‹çµæœ API (`/trial-submission/<id>/download/case`)
- [x] ä¸‹è¼‰æ‰€æœ‰çµæœ API (`/trial-submission/<id>/download`)
- [x] æ²™ç›’çµæœå›å ± API (`/trial-submission/<id>/result`)
- [x] ä¸‹è¼‰è‡ªè¨‚æ¸¬è³‡ API (`/trial-submission/download-testcases`)
- [x] Token ç®¡ç† (`assign_token`, `verify_token`)
- [x] æ¬Šé™æª¢æŸ¥ (owner/staff)
- [x] `allowWrite` å•é¡Œé™åˆ¶
- [x] æª”æ¡ˆå¤§å°é©—è­‰ (code: 10MB, custom: 5MB)

#### æ²™ç›’ (Sandbox)
- [x] Trial Submission æ¥æ”¶èˆ‡è™•ç† (`/submit/<id>`)
- [x] å…¬é–‹æ¸¬è³‡å¿«å– (`ensure_public_testdata`)
- [x] è‡ªè¨‚æ¸¬è³‡æº–å‚™ (`prepare_custom_testdata`)
- [x] AC Code åŸ·è¡Œå™¨ (`ACCodeRunner`)
- [x] å‹•æ…‹ä»»å‹™ç”Ÿæˆ (`scan_and_generate_tasks`)
- [x] å„ªå…ˆç´šè™•ç† (Trial å„ªå…ˆç´šä½æ–¼ Normal)
- [x] çµæœå›å ±åˆ°å¾Œç«¯
- [x] è‡ªè¨‚æ¸¬è³‡æ¸…ç† (`cleanup_custom_testdata`)
- [x] æ”¯æ´ Interactive æ¨¡å¼
- [x] æ”¯æ´ Custom Checker

---

## âš ï¸ ä¸è¶³ä¹‹è™•

### 1. **éŒ¯èª¤è™•ç†èˆ‡å›æ»¾æ©Ÿåˆ¶**

#### å•é¡Œ
- **MinIO ä¸Šå‚³å¤±æ•—å¾Œç„¡å›æ»¾**ï¼šå¦‚æœ `code` ä¸Šå‚³æˆåŠŸä½† `custom_testcases` ä¸Šå‚³å¤±æ•—ï¼Œ`code_minio_path` å·²å¯«å…¥è³‡æ–™åº«ï¼Œä½† `custom_input_minio_path` æœªå¯«å…¥ï¼Œç‹€æ…‹ä¸ä¸€è‡´ã€‚

```python
# model/trial_submission.py:194-216
# å¦‚æœ custom ä¸Šå‚³å¤±æ•—ï¼Œcode å·²ç¶“åœ¨ MinIO å’Œè³‡æ–™åº«ä¸­
minio.client.put_object(...)  # code æˆåŠŸ
# ... 
minio.client.put_object(...)  # custom å¤±æ•— â†’ ä½† code å·²ç¶“ä¿å­˜
```

**å»ºè­°**ï¼šå¯¦ä½œäº‹å‹™æ€§ä¸Šå‚³æˆ–è£œå„Ÿæ©Ÿåˆ¶ã€‚

#### å•é¡Œ
- **AC Code ç”Ÿæˆå¤±æ•—è™•ç†ä¸å®Œæ•´**ï¼šå¦‚æœ AC Code åŸ·è¡Œå¤±æ•—ï¼Œæœƒå¯«å…¥ç©º `.out` æª”æ¡ˆï¼Œä½†æ²’æœ‰æ˜ç¢ºçš„éŒ¯èª¤ç‹€æ…‹å›å ±çµ¦ç”¨æˆ¶ã€‚

```python
# dispatcher/ac_code.py:129-133
except ACCodeRunError as exc:
    logger().error(...)
    out_file.write_text("")  # å¯«ç©ºæª”æ¡ˆï¼Œä½†ç”¨æˆ¶ä¸çŸ¥é“ç‚ºä»€éº¼
```

**å»ºè­°**ï¼šè¨˜éŒ„å¤±æ•—åŸå› ï¼Œæˆ–å›å ±éŒ¯èª¤çµ¦å¾Œç«¯ã€‚

---

### 2. **Token å®‰å…¨æ€§**

#### å•é¡Œ
- **Token é©—è­‰å¾Œç«‹å³åˆªé™¤**ï¼š`verify_token` æˆåŠŸå¾Œæœƒåˆªé™¤ tokenï¼Œä½†å¦‚æœå¾Œç«¯è™•ç†çµæœæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œç„¡æ³•é‡è©¦ã€‚

```python
# mongo/submission.py:1644
if valid:
    cache.delete(key)  # ç«‹å³åˆªé™¤ï¼Œç„¡æ³•é‡è©¦
```

**å»ºè­°**ï¼šè€ƒæ…®ä½¿ç”¨ TTL è€Œéç«‹å³åˆªé™¤ï¼Œæˆ–å¯¦ä½œé‡è©¦æ©Ÿåˆ¶ã€‚

#### å•é¡Œ
- **Token æ²’æœ‰éæœŸæ™‚é–“æª¢æŸ¥**ï¼šé›–ç„¶ Redis å¯èƒ½è¨­å®š TTLï¼Œä½†ç¨‹å¼ç¢¼ä¸­æ²’æœ‰æ˜ç¢ºæª¢æŸ¥ã€‚

**å»ºè­°**ï¼šæ˜ç¢ºè¨­å®šå’Œæª¢æŸ¥ token TTLã€‚

---

### 3. **æª”æ¡ˆæ¸…ç†æ™‚æ©Ÿ**

#### å•é¡Œ
- **è‡ªè¨‚æ¸¬è³‡æ¸…ç†åªåœ¨æˆåŠŸæ™‚åŸ·è¡Œ**ï¼šå¦‚æœå¾Œç«¯å›å ±å¤±æ•—ï¼Œè‡ªè¨‚æ¸¬è³‡ä¸æœƒè¢«æ¸…ç†ï¼Œå¯èƒ½é€ æˆç£ç¢Ÿç©ºé–“æµªè²»ã€‚

```python
# dispatcher/dispatcher.py:1486-1495
if resp.ok:  # åªæœ‰æˆåŠŸæ™‚æ‰æ¸…ç†
    if is_trial:
        cleanup_custom_testdata(submission_id)
```

**å»ºè­°**ï¼šç„¡è«–æˆåŠŸå¤±æ•—éƒ½æ‡‰è©²æ¸…ç†ï¼ˆæˆ–è¨­å®š TTL è‡ªå‹•æ¸…ç†ï¼‰ã€‚

---

### 4. **å‹•æ…‹ä»»å‹™ç”Ÿæˆé©—è­‰**

#### å•é¡Œ
- **æ²’æœ‰é©—è­‰ç”Ÿæˆçš„ä»»å‹™æ ¼å¼**ï¼š`scan_and_generate_tasks` ç”Ÿæˆçš„ä»»å‹™å¯èƒ½ä¸ç¬¦åˆ `Meta` çš„é©—è­‰è¦å‰‡ã€‚

```python
# app.py:103-109
trial_tasks = scan_and_generate_tasks(testdata_path)
if trial_tasks:
    meta.tasks = [Task(**t) for t in trial_tasks]  # å¯èƒ½é©—è­‰å¤±æ•—
```

**å»ºè­°**ï¼šé©—è­‰ç”Ÿæˆçš„ä»»å‹™æ˜¯å¦ç¬¦åˆ `Meta` è¦ç¯„ã€‚

---

### 5. **ä¸¦ç™¼èˆ‡ç«¶æ…‹æ¢ä»¶**

#### å•é¡Œ
- **å¤šå€‹ Trial Submission åŒæ™‚ä½¿ç”¨ç›¸åŒå…¬é–‹æ¸¬è³‡**ï¼šé›–ç„¶æœ‰å¿«å–ï¼Œä½†æ²’æœ‰é–å®šæ©Ÿåˆ¶ï¼Œå¯èƒ½å°è‡´é‡è¤‡ä¸‹è¼‰ã€‚

**å»ºè­°**ï¼šä½¿ç”¨æª”æ¡ˆé–æˆ– Redis é–ã€‚

#### å•é¡Œ âœ… å·²ä¿®å¾©
- **å„ªå…ˆç´šæª¢æŸ¥é‚è¼¯éŒ¯èª¤**ï¼š`_has_pending_normal_jobs()` åŸæœ¬æª¢æŸ¥ `self.pending_tasks`ï¼Œä½†è©²è®Šæ•¸åªè¿½è¹¤ SA å®Œæˆå‰çš„ä»»å‹™ã€‚ç•¶ normal submission é€²å…¥åŸ·è¡Œéšæ®µå¾Œï¼Œ`pending_tasks[sid]` å·²è¢«æ¸…ç©ºï¼Œå°è‡´æ–¹æ³•éŒ¯èª¤è¿”å› `False`ã€‚

**å·²ä¿®å¾©**ï¼šæ”¹ç‚ºæª¢æŸ¥ `self.result[sid]` ä¸­æ˜¯å¦æœ‰æœªå®Œæˆçš„ casesï¼ˆå€¼ç‚º `None`ï¼‰ã€‚

```python
# ä¿®å¾©å¾Œçš„é‚è¼¯
def _has_pending_normal_jobs(self) -> bool:
    for sid in self.result.keys():
        if sid not in self.trial_submissions:
            _, results = self.result[sid]
            if any(v is None for v in results.values()):
                return True
    return False
```

---

### 6. **éŒ¯èª¤è¨Šæ¯èˆ‡æ—¥èªŒ**

#### å•é¡Œ
- **éŒ¯èª¤è¨Šæ¯ä¸å¤ è©³ç´°**ï¼šæŸäº›éŒ¯èª¤åªè¨˜éŒ„æ—¥èªŒï¼Œæ²’æœ‰å›å‚³çµ¦ç”¨æˆ¶æ˜ç¢ºçš„éŒ¯èª¤åŸå› ã€‚

**å»ºè­°**ï¼šæ”¹é€²éŒ¯èª¤è¨Šæ¯ï¼Œç‰¹åˆ¥æ˜¯ AC Code åŸ·è¡Œå¤±æ•—çš„æƒ…æ³ã€‚

---

### 7. **æ¸¬è©¦è¦†è“‹**

#### å•é¡Œ
- **ç¼ºå°‘æ•´åˆæ¸¬è©¦**ï¼šç›®å‰åªæœ‰å–®å…ƒæ¸¬è©¦ï¼Œç¼ºå°‘ç«¯å°ç«¯æ¸¬è©¦ã€‚

**å»ºè­°**ï¼šå¯¦ä½œ E2E æ¸¬è©¦ï¼Œæ¶µè“‹å®Œæ•´æµç¨‹ã€‚

---

## ğŸ› æ½›åœ¨ Bug

### Bug 1: æª”æ¡ˆæŒ‡æ¨™æœªé‡ç½®

**ä½ç½®**ï¼š`model/trial_submission.py:125`

```python
code_bytes = code_file.read()
# ... é©—è­‰ ...
code_file.read()  # æŒ‡æ¨™å·²åˆ°æœ«å°¾ï¼Œç„¡æ³•å†æ¬¡è®€å–
```

**å•é¡Œ**ï¼šå¦‚æœå¾ŒçºŒéœ€è¦å†æ¬¡è®€å– `code_file`ï¼Œæœƒå¾—åˆ°ç©ºå…§å®¹ã€‚

**å½±éŸ¿**ï¼šä½ï¼ˆç›®å‰æ²’æœ‰é‡è¤‡è®€å–çš„éœ€æ±‚ï¼‰

**ä¿®å¾©**ï¼š
```python
code_bytes = code_file.read()
code_file.seek(0)  # é‡ç½®æŒ‡æ¨™ï¼ˆå¦‚æœéœ€è¦ï¼‰
```

---

### Bug 2: æ¬Šé™æª¢æŸ¥é‚è¼¯ä¸ä¸€è‡´

**ä½ç½®**ï¼š`model/trial_submission.py` vs `model/trial_submission.py:272`

```python
# upload_trial_files:116
is_staff = req_user.role <= 1  # 0 admin, 1 teacher

# get_trial_record:272
is_staff = req_user.role in (Role.ADMIN, Role.TEACHER, Role.TA)  # åŒ…å« TA
```

**å•é¡Œ**ï¼šå…©å€‹ç«¯é»çš„æ¬Šé™æª¢æŸ¥é‚è¼¯ä¸ä¸€è‡´ã€‚

**å½±éŸ¿**ï¼šä¸­ï¼ˆå¯èƒ½å°è‡´æ¬Šé™æ¼æ´ï¼‰

**ä¿®å¾©**ï¼šçµ±ä¸€æ¬Šé™æª¢æŸ¥é‚è¼¯ã€‚

---

### Bug 3: ä»»å‹™ç´¢å¼•è¶Šç•Œé¢¨éšª

**ä½ç½®**ï¼š`model/trial_submission.py:318-321`

```python
if task_index < 0 or task_index >= len(ts.tasks):
    return HTTPError("Task index out of range.", 404)

case_result = ts.tasks[task_index].cases[0]  # å‡è¨­ cases[0] å­˜åœ¨
```

**å•é¡Œ**ï¼šå¦‚æœ `cases` ç‚ºç©ºï¼Œæœƒå°è‡´ `IndexError`ã€‚

**å½±éŸ¿**ï¼šä¸­ï¼ˆå¯èƒ½å°è‡´ 500 éŒ¯èª¤ï¼‰

**ä¿®å¾©**ï¼š
```python
if not task.cases:
    return HTTPError("No cases found for this task.", 404)
case_result = task.cases[0]
```

---

### Bug 4: AC Code èªè¨€æ˜ å°„ç¼ºå¤±

**ä½ç½®**ï¼š`dispatcher/ac_code.py:50-53`

```python
lang_key = LANG_KEY_MAP.get(lang_enum)
if lang_key is None:
    raise ValueError(f"Unsupported AC code language: {language}")
```

**å•é¡Œ**ï¼šå¦‚æœå•é¡Œä½¿ç”¨å…¶ä»–èªè¨€ï¼ˆå¦‚ Javaï¼‰ï¼Œæœƒå°è‡´éŒ¯èª¤ã€‚

**å½±éŸ¿**ï¼šä½ï¼ˆç›®å‰åªæ”¯æ´ C/C++/Pythonï¼‰

**ä¿®å¾©**ï¼šæ˜ç¢ºæ”¯æ´çš„èªè¨€åˆ—è¡¨ï¼Œæˆ–æä¾›æ›´å‹å–„çš„éŒ¯èª¤è¨Šæ¯ã€‚

---

### Bug 5: è‡ªè¨‚æ¸¬è³‡æª”åè½‰æ›é‚è¼¯

**ä½ç½®**ï¼š`dispatcher/trial_testdata.py:70-75`

```python
for idx, in_file in enumerate(in_files):
    new_name = f"00{idx:02d}.in"  # 0000, 0001, 0002...
```

**å•é¡Œ**ï¼šå¦‚æœç”¨æˆ¶ä¸Šå‚³çš„æª”æ¡ˆè¶…é 100 å€‹ï¼Œæª”åæœƒé‡è¤‡ï¼ˆ`00{100:02d}` = `00100`ï¼Œä½†æ‡‰è©²æ˜¯ `0100`ï¼‰ã€‚

**å½±éŸ¿**ï¼šä½ï¼ˆé€šå¸¸ä¸æœƒè¶…é 100 å€‹æ¸¬è³‡ï¼‰

**ä¿®å¾©**ï¼š
```python
# ç¢ºä¿ task ç·¨è™Ÿæ­£ç¢º
task_no = idx // 100
case_no = idx % 100
new_name = f"{task_no:02d}{case_no:02d}.in"
```

---

### Bug 6: Token é©—è­‰çš„æ™‚åºå•é¡Œ

**ä½ç½®**ï¼š`mongo/submission.py:1638-1645`

```python
s_token = cache.get(key)
if s_token is None:
    return False
s_token = s_token.decode('ascii')
valid = secrets.compare_digest(s_token, token)
if valid:
    cache.delete(key)  # åˆªé™¤å¾Œï¼Œå¦‚æœå¾ŒçºŒè™•ç†å¤±æ•—ï¼Œç„¡æ³•é‡è©¦
```

**å•é¡Œ**ï¼šå¦‚æœ `process_result` å¤±æ•—ï¼Œtoken å·²åˆªé™¤ï¼Œç„¡æ³•é‡è©¦ã€‚

**å½±éŸ¿**ï¼šä¸­ï¼ˆå¯èƒ½å°è‡´çµæœéºå¤±ï¼‰

**ä¿®å¾©**ï¼šå»¶é²åˆªé™¤ tokenï¼Œæˆ–å¯¦ä½œé‡è©¦æ©Ÿåˆ¶ã€‚

---

### Bug 7: çµæœå›å ±çš„éŒ¯èª¤è™•ç†

**ä½ç½®**ï¼š`dispatcher/dispatcher.py:1456-1499`

```python
resp = requests.put(endpoint, json=submission_data)
if resp.ok:
    # æ¸…ç†æª”æ¡ˆ
    file_manager.clean_data(submission_id)
    if is_trial:
        cleanup_custom_testdata(submission_id)
else:
    file_manager.backup_data(submission_id)  # åªå‚™ä»½ï¼Œä¸æ¸…ç† trial è³‡æ–™
```

**å•é¡Œ**ï¼šå¦‚æœå¾Œç«¯å›å ±å¤±æ•—ï¼ˆ`resp.ok = False`ï¼‰ï¼Œtrial çš„è‡ªè¨‚æ¸¬è³‡ä¸æœƒè¢«æ¸…ç†ã€‚

**å½±éŸ¿**ï¼šä¸­ï¼ˆç£ç¢Ÿç©ºé–“æµªè²»ï¼‰

**ä¿®å¾©**ï¼šç„¡è«–æˆåŠŸå¤±æ•—éƒ½æ¸…ç† trial è³‡æ–™ï¼Œæˆ–è¨­å®š TTLã€‚

---

## ğŸ”§ æ”¹é€²å»ºè­°

### å„ªå…ˆç´šï¼šé«˜

1. **çµ±ä¸€æ¬Šé™æª¢æŸ¥é‚è¼¯**ï¼šç¢ºä¿æ‰€æœ‰ç«¯é»ä½¿ç”¨ç›¸åŒçš„æ¬Šé™æª¢æŸ¥ã€‚
2. **ä¿®å¾©ä»»å‹™ç´¢å¼•è¶Šç•Œ**ï¼šæª¢æŸ¥ `cases` æ˜¯å¦ç‚ºç©ºã€‚
3. **æ”¹é€²éŒ¯èª¤è™•ç†**ï¼šAC Code å¤±æ•—æ™‚æä¾›æ›´æ˜ç¢ºçš„éŒ¯èª¤è¨Šæ¯ã€‚
4. **Token é‡è©¦æ©Ÿåˆ¶**ï¼šå¯¦ä½œ token é©—è­‰å¤±æ•—å¾Œçš„é‡è©¦é‚è¼¯ã€‚

### å„ªå…ˆç´šï¼šä¸­

5. **æª”æ¡ˆä¸Šå‚³äº‹å‹™æ€§**ï¼šç¢ºä¿ä¸Šå‚³çš„åŸå­æ€§ã€‚
6. **è‡ªè¨‚æ¸¬è³‡æ¸…ç†æ™‚æ©Ÿ**ï¼šç„¡è«–æˆåŠŸå¤±æ•—éƒ½æ¸…ç†ã€‚
7. **å‹•æ…‹ä»»å‹™ç”Ÿæˆé©—è­‰**ï¼šé©—è­‰ç”Ÿæˆçš„ä»»å‹™æ ¼å¼ã€‚
8. **ä¸¦ç™¼æ§åˆ¶**ï¼šä½¿ç”¨é–å®šæ©Ÿåˆ¶é˜²æ­¢ç«¶æ…‹æ¢ä»¶ã€‚

### å„ªå…ˆç´šï¼šä½

9. **æª”æ¡ˆæŒ‡æ¨™é‡ç½®**ï¼šç¢ºä¿æª”æ¡ˆæŒ‡æ¨™æ­£ç¢ºã€‚
10. **æª”åè½‰æ›é‚è¼¯**ï¼šæ”¯æ´è¶…é 100 å€‹æ¸¬è³‡çš„æƒ…æ³ã€‚
11. **èªè¨€æ”¯æ´æ“´å±•**ï¼šæ˜ç¢ºæ”¯æ´çš„èªè¨€åˆ—è¡¨ã€‚
12. **E2E æ¸¬è©¦**ï¼šå¯¦ä½œç«¯å°ç«¯æ¸¬è©¦ã€‚

---

## ğŸ“ ç¸½çµ

### å®Œæˆåº¦ï¼š**85%** âœ…

**æ ¸å¿ƒåŠŸèƒ½å·²å¯¦ä½œå®Œæˆ**ï¼ŒåŒ…æ‹¬ï¼š
- å®Œæ•´çš„ API ç«¯é»
- æ²™ç›’æ•´åˆ
- åŸºæœ¬éŒ¯èª¤è™•ç†
- æ¬Šé™æ§åˆ¶

**ä¸»è¦ä¸è¶³**ï¼š
- éŒ¯èª¤è™•ç†èˆ‡å›æ»¾æ©Ÿåˆ¶
- ä¸¦ç™¼æ§åˆ¶
- æ¸¬è©¦è¦†è“‹

**å»ºè­°å„ªå…ˆä¿®å¾©çš„ Bug**ï¼š
1. æ¬Šé™æª¢æŸ¥ä¸ä¸€è‡´
2. ä»»å‹™ç´¢å¼•è¶Šç•Œ
3. Token é‡è©¦æ©Ÿåˆ¶
4. è‡ªè¨‚æ¸¬è³‡æ¸…ç†æ™‚æ©Ÿ

æ•´é«”è€Œè¨€ï¼ŒåŠŸèƒ½å·²å¯æŠ•å…¥ä½¿ç”¨ï¼Œä½†å»ºè­°åœ¨ç”Ÿç”¢ç’°å¢ƒå‰ä¿®å¾©ä¸Šè¿°é«˜å„ªå…ˆç´šå•é¡Œã€‚


