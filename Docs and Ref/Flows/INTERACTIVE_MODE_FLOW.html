<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Mode Submission Flow</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .mermaid {
            width: 100%;
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body>
    <h1>Interactive Mode Submission Flow</h1>
    <pre class="mermaid">
sequenceDiagram
    participant User
    participant Frontend as Frontend (submit.vue)
    participant BackendAPI as Backend API (app.py)
    participant BackendModel as Backend Model (submission.py)
    participant SandboxAPI as Sandbox API (app.py)
    participant Dispatcher as Sandbox Dispatcher (dispatcher.py)
    participant BuildStrategy as Build Strategy (build_strategy.py)
    participant Orchestrator as Interactive Orchestrator (interactive_orchestrator.py)
    participant SandboxBin as sandbox_interactive

    User->>Frontend: Upload Code (Code/Zip)
    Frontend->>Frontend: Validate Format (acceptedFormat)
    Frontend->>BackendAPI: POST /submission/ (create_submission)
    BackendAPI->>BackendModel: Submission.add()
    BackendModel-->>BackendAPI: submission_id
    BackendAPI-->>Frontend: submission_id

    Frontend->>BackendAPI: PUT /submission/{id} (update_submission)
    BackendAPI->>BackendModel: submission.submit(code)
    BackendModel->>BackendModel: _put_code(code) (Upload to MinIO)
    BackendModel->>BackendModel: send()
    BackendModel->>SandboxAPI: POST /submit/{id}

    SandboxAPI->>Dispatcher: prepare_submission_dir()
    Dispatcher->>Dispatcher: file_manager.extract()
    SandboxAPI->>Dispatcher: handle(submission_id)
    Dispatcher->>Dispatcher: get_problem_meta()
    
    Note over Dispatcher: Detects executionMode="interactive"<br/>and buildStrategy="makeInteractive"

    Dispatcher->>Dispatcher: _prepare_with_build_strategy()
    Dispatcher->>Dispatcher: _prepare_teacher_file()
    Dispatcher->>Dispatcher: Download Teacher_file from MinIO
    Dispatcher->>Dispatcher: Write teacher/main.{c,cpp,py}
    
    Dispatcher->>BuildStrategy: prepare_make_interactive()
    BuildStrategy->>BuildStrategy: _prepare_teacher_artifacts()
    
    alt Teacher Lang = C/C++
        BuildStrategy->>BuildStrategy: Compile teacher (gcc/g++)
        BuildStrategy->>BuildStrategy: Create Teacher_main binary
    else Teacher Lang = Python
        BuildStrategy->>BuildStrategy: Skip compile (use main.py)
    end
    
    BuildStrategy->>BuildStrategy: _build_plan_for_student_artifacts()
    
    alt Submission has Makefile
        BuildStrategy-->>Dispatcher: BuildPlan (needs_make=True)
    else No Makefile (CODE mode)
        BuildStrategy-->>Dispatcher: BuildPlan (needs_make=False)
    end

    opt needs_make=True
        Dispatcher->>Dispatcher: queue.put(job.Build)
    end
    Dispatcher->>Dispatcher: queue.put(job.Execute Ã— N cases)

    loop Dispatcher Run Loop
        Dispatcher->>Dispatcher: job = queue.get()
        
        alt job.Build
            Dispatcher->>Dispatcher: build()
            Dispatcher->>BuildStrategy: build_with_make()
            BuildStrategy-->>Dispatcher: Result (AC/CE)
        else job.Execute
            Dispatcher->>Dispatcher: create_container()
            Dispatcher->>Orchestrator: InteractiveRunner.run()
            Orchestrator->>Orchestrator: Setup directories & permissions
            Orchestrator->>Orchestrator: Inject testcase.in to teacher/
            
            alt Pipe Mode = FIFO
                Orchestrator->>Orchestrator: Create FIFO pipes (s2t.fifo, t2s.fifo)
            else Pipe Mode = devfd (fallback)
                Orchestrator->>Orchestrator: Create /dev/fd pipes
            end
            
            Orchestrator->>Orchestrator: Build sandbox_interactive commands
            
            alt teacherFirst = True
                Orchestrator->>SandboxBin: Start Teacher Process
                Note over Orchestrator: Sleep 50ms
                Orchestrator->>SandboxBin: Start Student Process
            else teacherFirst = False
                Orchestrator->>SandboxBin: Start Student Process
                Note over Orchestrator: Sleep 50ms
                Orchestrator->>SandboxBin: Start Teacher Process
            end
            
            par Concurrent Execution
                SandboxBin->>SandboxBin: Student runs (stdin=teacher_stdout)
                SandboxBin->>SandboxBin: Teacher runs (stdin=student_stdout)
            end
            
            Orchestrator->>Orchestrator: Watchdog monitors (deadline)
            
            alt Both Exit Normally
                Orchestrator->>Orchestrator: Read student.result
                Orchestrator->>Orchestrator: Read teacher.result
            else Timeout
                Orchestrator->>SandboxBin: Kill both processes
            end
            
            alt Student Status != AC
                Orchestrator-->>Dispatcher: Return Student Status (CE/RE/TLE/MLE)
            else Teacher Status != AC
                Orchestrator-->>Dispatcher: Return Teacher Status (CE/RE/TLE/MLE)
            else Both AC
                Orchestrator->>Orchestrator: Parse teacher/Check_Result
                alt Check_Result Valid (AC/WA)
                    Orchestrator-->>Dispatcher: Return AC/WA + MESSAGE
                else Check_Result Invalid
                    Orchestrator-->>Dispatcher: Return CE (Invalid Check_Result)
                end
            end
            
            Orchestrator->>Orchestrator: Cleanup (remove testcase.in, tmpdir)
            Dispatcher->>Dispatcher: on_case_complete()
        end
    end

    Dispatcher->>Dispatcher: on_submission_complete()
    Dispatcher->>BackendAPI: PUT /submission/{id}/complete
    BackendAPI->>BackendModel: on_submission_complete()
    BackendModel->>BackendModel: process_result()
    BackendModel->>BackendModel: finish_judging()
    </pre>
</body>
</html>
